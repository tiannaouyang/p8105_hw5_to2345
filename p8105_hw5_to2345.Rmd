---
title: "p8105_hw5_to2345"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
set.seed(10)

iris_with_missing = 
  iris %>% 
  map_df(~replace(.x, sample(1:150, 20), NA)) %>% 
  mutate(Species = as.character(Species))


```

# Problem 1
For numeric variables, you should fill in missing values with the mean of non-missing values
For character variables, you should fill in missing values with "virginica"
```{r question1}
fill_na = function(x) {
  output = vector(length = length(x))
  for (i in 1:length(x)) {
    if (is.numeric(x[i])) {
      mean_i = mean(x[!is.na(x)])
      if (!is.na(x[i])) {
        output[i] = x[i]
      } else {
        output[i] = mean_i
      }
    } else if (is.character(x[i])) {
      if (!is.na(x[i])) {
        output[i] = x[i]
      } else {
        output[i] = "virginica"
      }
    }
  }
  output
}

iris_filled = map(iris_with_missing, fill_na) %>%
  as.data.frame()
```

# Problem 2

```{r question2, warning=FALSE, message = FALSE}
filenames = list.files("data")

study_data = 
  tibble(
    filenames = list.files("data"),
    path = str_c("./data/", filenames)
  ) %>% 
  mutate(
    data = map(path, read_csv)
  ) %>% 
  unnest() %>% 
  select(-path) %>% 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    values_to = "obs"
  ) %>% 
  mutate(
    arm = substr(filenames, 1, 3),
    arm = recode(arm, "con" = "control",
                      "exp" = "experiment"),
    subject_id = substr(filenames, 5, 6),
    subject_id = as.numeric(subject_id),
    week = substr(week, 6, 7),
    week = as.numeric(week)
  ) %>% 
  select(-filenames)

```

Here is the spaghetti plot showing observations on each subject over time
```{r spaghetti}

study_data %>% 
  ggplot(
    aes(
      x = week,
      y = obs,
      group = subject_id
    )
  ) +
  geom_line() + 
  stat_smooth(
    aes(group = 1),
    method = "lm"
    ) +
  facet_grid(. ~arm) +
  theme_minimal() +
  ylab("observation")

```

Comment: From the spaghetti plot, we can clearly see that the weekly observation for the experiment group increases as time increases; however, the observed data on the control arm did not show improvement in the outcome and slight decrease is observed.


# Problem 3
```{r question3}

sim_regression = function (n = 30, beta0 = 2, beta1 = 0, sigma = 50){
  
  sim_data = tibble(
    xi1 = rnorm(n, 0, 1),
    yi = beta0 + beta1*xi1 + rnorm(n, 0, sigma)
)
  
  ls_fit = lm(yi ~ xi1, data = sim_data)
  
  tibble(
    beta2 = broom::tidy(ls_fit)$estimate[2],
    p_value = broom::tidy(ls_fit)$p.value[2],
    alpha = 0.5
  )
}

rerun(10000, sim_regression())
```


```{r}
sim_results = 
  tibble(beta1s = c(1,2,3,4,5,6)) %>% 
  mutate(
    output_list = map(.x = beta1s, ~rerun(100, sim_regression(beta1 = .x))),
    estimate_dfs = map(output_list, bind_rows)
  ) %>% 
  select(-output_list) %>% 
  unnest(estimate_dfs) %>% 
  mutate(
    reject_null = ifelse(p_value < alpha, 1, 0)
  )
  
```


```{r}
sim_results %>% 
  group_by(beta2) %>% 
  mutate(
    sum_reject_null = sum(reject_null),
    avg_reject_null = mean(sum_reject_null)) %>% 
  ungroup() %>% 
  ggplot(
    aes(
      x = beta2,
      y = p_value
    )
  ) +
  geom_point()



```



